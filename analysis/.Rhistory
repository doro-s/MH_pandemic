install.packages('tidyverse')
library(tidyverse)
library(tidyverse)
read_csv('D:MH_pandemic\output\input_cis_vl.csv')
library(tidyverse)
read_csv('D:\\MH_pandemic\\output\\input_cis_vl.csv')
library(tidyverse)
cis_wide <- read_csv('D:\\MH_pandemic\\output\\input_cis_vl.csv')
View(cis_wide)
str(cis_wide)
colnames(cis_wide)
cis_long <- cis_wide %>%
select(patient_id, matches('cis\\_visit\\_date\\d+'))
View(cis_long)
cis_long <- cis_wide %>%
select(patient_id, matches('cis\\_visit\\_date\\_\\d+'))
View(cis_long)
cis_long <- cis_wide %>%
select(patient_id, matches('cis\\_visit\\_date\\_\\d+')) %>%
pivot_longer(cols = -patient_id,
names_to = c(NA, 'cis_visit_date'),
names_pattern = '^(.*)_(\\d+)',
values_to = 'visit_date',
values_drop_na = TRUE) %>%
arrange(patient_id, date)
cis_long <- cis_wide %>%
select(patient_id, matches('cis\\_visit\\_date\\_\\d+')) %>%
pivot_longer(cols = -patient_id,
names_to = c(NA, 'cis_visit_date'),
names_pattern = '^(.*)_(\\d+)',
values_to = 'visit_date',
values_drop_na = TRUE)
View(cis_long)
cis_long <- cis_wide %>%
select(patient_id, matches('cis\\_visit\\_date\\_\\d+')) %>%
pivot_longer(cols = -patient_id,
names_to = c(NA, 'cis_visit_date'),
names_pattern = '^(.*)_(\\d+)',
values_to = 'visit_date',
values_drop_na = TRUE) %>%
arrange(patient_id, visit_date)
library(tidyverse)
cis_wide <- read_csv('D:\\MH_pandemic\\output\\input_cis_vl.csv')
cis_long <- cis_wide %>%
select(patient_id, matches('cis\\_visit\\_date\\_\\d+')) %>%
pivot_longer(cols = -patient_id,
names_to = c(NA, 'visit_number'),
names_pattern = '^(.*)_(\\d+)',
values_to = 'visit_date',
values_drop_na = TRUE) %>%
arrange(patient_id, visit_number)
View(cis_long)
library(tidyverse)
cis_wide <- read_csv('D:\\MH_pandemic\\output\\input_cis_vl.csv')
cis_long <- cis_wide %>%
select(patient_id, matches('cis\\_visit\\_date\\_\\d+')) %>%
pivot_longer(cols = -patient_id,
names_to = c(NA, 'visit_number'),
names_pattern = '^(.*)_(\\d+)',
values_to = 'visit_date',
values_drop_na = TRUE) %>%
arrange(patient_id, visit_number)
write_csv(cis_long, 'D:\\MH_pandemic\\output\\cis_long.csv')
library(tidyverse)
library(lubridate)
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
cis <- read_csv('../output/input_reconciled.csv')
# Drop non-cis participants (no visit dates)
# Drop anything after 30th September 2021 - end of study date
cis <- cis %>%
filter(!is.na(visit_date)) %>%
filter(visit_date <= '2021-09-30')
# For rows where date is NA (no observation), make arbitrarily large date
cis <- cis %>%
mutate(date_of_death = if_else(is.na(date_of_death), as.Date('2100-01-01'), date_of_death),
covid_hes = if_else(is.na(covid_hes), as.Date('2100-01-01'), covid_hes),
covid_tt = if_else(is.na(covid_tt), as.Date('2100-01-01'), covid_tt),
covid_vaccine = if_else(is.na(covid_vaccine), as.Date('2100-01-01'), covid_vaccine),
first_pos_swab = if_else(is.na(first_pos_swab), as.Date('2100-01-01'), first_pos_swab),
first_pos_blood = if_else(is.na(first_pos_blood), as.Date('2100-01-01'), first_pos_blood))
# Rearrange rows so that visit dates are monotonically increasing
# Shouldn't be a problem in the real data but will affect pipeline development
cis <- cis %>%
arrange(patient_id, visit_date)
# Remove rows where date of death < visit date
# Won't be necessary in actual data
cis <- cis %>%
filter(date_of_death > visit_date)
# Add 365 days to most recent visit date per person,
# do not link to anything after this date
cis <- cis %>%
group_by(patient_id) %>%
mutate(visit_date_one_year = max(visit_date) + 365,
eos_date = as.Date('2021-09-30')) %>%
ungroup()
# Derive all source dates for entire cis data
# Earliest date of +ve test in cis
cis_never_pos <- cis %>%
group_by(patient_id) %>%
mutate(ever_tested_pos = ifelse(sum(result_mk) > 0, 1, 0)) %>%
filter(ever_tested_pos == 0) %>%
mutate(min_pos_date_cis = as.Date('2100-01-01')) %>%
ungroup() %>%
select(patient_id, min_pos_date_cis, eos_date, visit_date_one_year) %>%
distinct(.keep_all = TRUE)
cis_pos <- cis %>%
filter(result_mk == 1) %>%
group_by(patient_id) %>%
mutate(min_pos_date_cis = min(visit_date)) %>%
filter(min_pos_date_cis == visit_date) %>%
ungroup() %>%
select(patient_id, min_pos_date_cis, eos_date, visit_date_one_year) %>%
distinct(.keep_all = TRUE)
cis_dates <- rbind(cis_never_pos, cis_pos)
# Derive earliest +ve dates per source (T&T, HES)
min_pos_tt <- cis %>%
group_by(patient_id) %>%
mutate(min_pos_date_tt = min(covid_tt)) %>%
filter(min_pos_date_tt == covid_tt) %>%
ungroup() %>%
select(patient_id, min_pos_date_tt) %>%
distinct(.keep_all = TRUE)
min_pos_hes <- cis %>%
group_by(patient_id) %>%
mutate(min_pos_date_hes = min(covid_hes)) %>%
filter(min_pos_date_hes == covid_hes) %>%
ungroup() %>%
select(patient_id, min_pos_date_hes) %>%
distinct(.keep_all = TRUE)
# Link T&T to CIS +ve cases
cis_dates <- cis_dates %>%
left_join(min_pos_tt, by = 'patient_id') %>%
left_join(min_pos_hes, by = 'patient_id')
# UNDO ANY JOINS WHERE T&T HAPPENS AFTER visit_date_one_year
cis_dates <- cis_dates %>%
mutate(min_pos_date_tt = if_else(min_pos_date_tt > visit_date_one_year, as.Date('2100-01-01'), min_pos_date_tt),
min_pos_date_hes = if_else(min_pos_date_hes > visit_date_one_year, as.Date('2100-01-01'), min_pos_date_hes))
View(cis_dates)
View(cis)
View(cis)
vacc_cis <- cis %>%
group_by(patient_id) %>%
mutate(vacc_date = min(covid_vaccine)) %>%
filter(vacc_date == covid_vaccine) %>%
ungroup() %>%
select(patient_id, vacc_date) %>%
distinct(.keep_all = TRUE)
View(vacc_cis)
earliest_pos_blood <- cis %>%
filter(result_combined == 1) %>%
group_by(patient_id) %>%
mutate(min_pos_date_blood = min(visit_date)) %>%
filter(min_pos_date_blood == visit_date) %>%
filter(min_pos_date_blood <= '2021-09-30') %>%
ungroup() %>%
select(participant_id, nhs_number, min_pos_date_blood,
covid_test_blood_pos_first_date, covid_test_swab_pos_first_date) %>%
distinct(.keep_all = TRUE)
# Earliest positive blood result
earliest_pos_blood <- cis %>%
filter(result_combined == 1) %>%
group_by(patient_id) %>%
mutate(min_pos_date_blood = min(visit_date)) %>%
filter(min_pos_date_blood == visit_date) %>%
filter(min_pos_date_blood <= '2021-09-30') %>%
ungroup() %>%
select(patient_id, nhs_number, min_pos_date_blood,
covid_test_blood_pos_first_date, covid_test_swab_pos_first_date) %>%
distinct(.keep_all = TRUE)
# Earliest positive blood result
earliest_pos_blood <- cis %>%
filter(result_combined == 1) %>%
group_by(patient_id) %>%
mutate(min_pos_date_blood = min(visit_date)) %>%
filter(min_pos_date_blood == visit_date) %>%
filter(min_pos_date_blood <= '2021-09-30') %>%
ungroup() %>%
select(patient_id, min_pos_date_blood,
covid_test_blood_pos_first_date, covid_test_swab_pos_first_date) %>%
distinct(.keep_all = TRUE)
# Earliest positive blood result
earliest_pos_blood <- cis %>%
filter(result_combined == 1) %>%
group_by(patient_id) %>%
mutate(min_pos_date_blood = min(visit_date)) %>%
filter(min_pos_date_blood == visit_date) %>%
filter(min_pos_date_blood <= '2021-09-30') %>%
ungroup() %>%
select(patient_id, min_pos_date_blood,
first_pos_swab, first_pos_blood) %>%
distinct(.keep_all = TRUE)
View(earliest_pos_blood)
# Earliest positive blood result
earliest_pos_blood <- cis %>%
group_by(patient_id) %>%
mutate(min_pos_date_blood = min(first_pos_blood)) %>%
filter(min_pos_date_blood == first_pos_blood) %>%
filter(min_pos_date_blood <= '2021-09-30') %>%
ungroup() %>%
select(patient_id, min_pos_date_blood,
first_pos_swab, first_pos_blood) %>%
distinct(.keep_all = TRUE)
# Earliest positive blood result
earliest_pos_blood <- cis %>%
group_by(patient_id) %>%
mutate(min_pos_date_blood = min(first_pos_blood)) %>%
filter(min_pos_date_blood == first_pos_blood) %>%
ungroup() %>%
select(patient_id, min_pos_date_blood,
first_pos_swab, first_pos_blood) %>%
distinct(.keep_all = TRUE)
View(earliest_pos_blood)
# Earliest positive blood result
earliest_pos_blood <- cis %>%
group_by(patient_id) %>%
mutate(min_pos_date_blood = min(first_pos_blood)) %>%
filter(min_pos_date_blood == first_pos_blood) %>%
ungroup() %>%
select(patient_id, min_pos_date_blood) %>%
distinct(.keep_all = TRUE)
View(earliest_pos_blood)
# Join vaccine dates to earliest +ve blood
earliest_pos_blood <- earliest_pos_blood %>%
left_join(vacc_cis, by = 'patient_id') %>%
select(-patient_id)
View(earliest_pos_blood)
View(cis)
library(tidyverse)
library(lubridate)
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
cis <- read_csv('../output/input_reconciled.csv')
# Drop non-cis participants (no visit dates)
# Drop anything after 30th September 2021 - end of study date
cis <- cis %>%
filter(!is.na(visit_date)) %>%
filter(visit_date <= '2021-09-30')
# For rows where date is NA (no observation), make arbitrarily large date
cis <- cis %>%
mutate(date_of_death = if_else(is.na(date_of_death), as.Date('2100-01-01'), date_of_death),
covid_hes = if_else(is.na(covid_hes), as.Date('2100-01-01'), covid_hes),
covid_tt = if_else(is.na(covid_tt), as.Date('2100-01-01'), covid_tt),
covid_vaccine = if_else(is.na(covid_vaccine), as.Date('2100-01-01'), covid_vaccine),
first_pos_swab = if_else(is.na(first_pos_swab), as.Date('2100-01-01'), first_pos_swab),
first_pos_blood = if_else(is.na(first_pos_blood), as.Date('2100-01-01'), first_pos_blood))
# Rearrange rows so that visit dates are monotonically increasing
# Shouldn't be a problem in the real data but will affect pipeline development
cis <- cis %>%
arrange(patient_id, visit_date)
# Remove rows where date of death < visit date
# Won't be necessary in actual data
cis <- cis %>%
filter(date_of_death > visit_date)
# Add 365 days to most recent visit date per person,
# do not link to anything after this date
cis <- cis %>%
group_by(patient_id) %>%
mutate(visit_date_one_year = max(visit_date) + 365,
eos_date = as.Date('2021-09-30')) %>%
ungroup()
# Derive all source dates for entire cis data
# Earliest date of +ve test in cis
cis_never_pos <- cis %>%
group_by(patient_id) %>%
mutate(ever_tested_pos = ifelse(sum(result_mk) > 0, 1, 0)) %>%
filter(ever_tested_pos == 0) %>%
mutate(min_pos_date_cis = as.Date('2100-01-01')) %>%
ungroup() %>%
select(patient_id, min_pos_date_cis, eos_date, visit_date_one_year) %>%
distinct(.keep_all = TRUE)
cis_pos <- cis %>%
filter(result_mk == 1) %>%
group_by(patient_id) %>%
mutate(min_pos_date_cis = min(visit_date)) %>%
filter(min_pos_date_cis == visit_date) %>%
ungroup() %>%
select(patient_id, min_pos_date_cis, eos_date, visit_date_one_year) %>%
distinct(.keep_all = TRUE)
cis_dates <- rbind(cis_never_pos, cis_pos)
# Derive earliest +ve dates per source (T&T, HES)
min_pos_tt <- cis %>%
group_by(patient_id) %>%
mutate(min_pos_date_tt = min(covid_tt)) %>%
filter(min_pos_date_tt == covid_tt) %>%
ungroup() %>%
select(patient_id, min_pos_date_tt) %>%
distinct(.keep_all = TRUE)
min_pos_hes <- cis %>%
group_by(patient_id) %>%
mutate(min_pos_date_hes = min(covid_hes)) %>%
filter(min_pos_date_hes == covid_hes) %>%
ungroup() %>%
select(patient_id, min_pos_date_hes) %>%
distinct(.keep_all = TRUE)
# Link T&T to CIS +ve cases
cis_dates <- cis_dates %>%
left_join(min_pos_tt, by = 'patient_id') %>%
left_join(min_pos_hes, by = 'patient_id')
# UNDO ANY JOINS WHERE T&T HAPPENS AFTER visit_date_one_year
cis_dates <- cis_dates %>%
mutate(min_pos_date_tt = if_else(min_pos_date_tt > visit_date_one_year, as.Date('2100-01-01'), min_pos_date_tt),
min_pos_date_hes = if_else(min_pos_date_hes > visit_date_one_year, as.Date('2100-01-01'), min_pos_date_hes))
# Minimum blood test date in CIS as 3rd date column
# First dose date
vacc_cis <- cis %>%
group_by(patient_id) %>%
mutate(vacc_date = min(covid_vaccine)) %>%
filter(vacc_date == covid_vaccine) %>%
ungroup() %>%
select(patient_id, vacc_date) %>%
distinct(.keep_all = TRUE)
# Earliest positive blood result
earliest_pos_blood <- cis %>%
group_by(patient_id) %>%
mutate(min_pos_date_blood = min(first_pos_blood)) %>%
filter(min_pos_date_blood == first_pos_blood) %>%
ungroup() %>%
select(patient_id, min_pos_date_blood) %>%
distinct(.keep_all = TRUE)
# Join vaccine dates to earliest +ve blood
earliest_pos_blood <- earliest_pos_blood %>%
left_join(vacc_cis, by = 'patient_id')
View(earliest_pos_blood)
View(earliest_pos_blood)
# Earliest positive blood result
earliest_pos_blood <- cis %>%
filter(result_combined == 1) %>%
group_by(patient_id) %>%
mutate(min_pos_date_blood = min(first_pos_blood)) %>%
filter(min_pos_date_blood == first_pos_blood) %>%
ungroup() %>%
select(patient_id, min_pos_date_blood) %>%
distinct(.keep_all = TRUE)
View(earliest_pos_blood)
# Join vaccine dates to earliest +ve blood
earliest_pos_blood <- earliest_pos_blood %>%
left_join(vacc_cis, by = 'patient_id')
View(earliest_pos_blood)
# Earliest positive blood result
earliest_pos_blood <- cis %>%
filter(result_combined == 1) %>%
group_by(patient_id) %>%
mutate(min_pos_result_comb = min(visit_date)) %>%
filter(min_pos_result_comb == visit_date) %>%
ungroup() %>%
select(patient_id, min_pos_result_comb) %>%
distinct(.keep_all = TRUE)
# Join vaccine dates to earliest +ve blood
earliest_pos_blood <- earliest_pos_blood %>%
left_join(vacc_cis, by = 'patient_id')
View(earliest_pos_blood)
# Earliest +ve from self reported swab or blood test
min_pos_swab <- cis %>%
group_by(patient_id) %>%
mutate(min_self_blood = min(first_pos_blood)) %>%
filter(min_self_blood == first_pos_blood) %>%
ungroup() %>%
select(patient_id, min_self_blood) %>%
distinct(.keep_all = TRUE)
# Earliest +ve from self reported swab or blood test
min_pos_blood <- cis %>%
group_by(patient_id) %>%
mutate(min_self_blood = min(first_pos_blood)) %>%
filter(min_self_blood == first_pos_blood) %>%
ungroup() %>%
select(patient_id, min_self_blood) %>%
distinct(.keep_all = TRUE)
View(min_pos_blood)
min_pos_swab <- cis %>%
group_by(patient_id) %>%
mutate(min_self_swab = min(first_pos_swab)) %>%
filter(min_self_swab == first_pos_swab) %>%
ungroup() %>%
select(patient_id, min_self_swab) %>%
distinct(.keep_all = TRUE)
View(min_pos_swab)
# Join vaccine dates to earliest +ve blood (and self reported dates)
earliest_pos_blood <- earliest_pos_blood %>%
left_join(vacc_cis, by = 'patient_id') %>%
left_join(min_pos_blood, by = 'patient_id') %>%
left_join(min_pos_swab, by = 'patient_id')
View(earliest_pos_blood)
# Minimum blood test date in CIS as 3rd date column
# First dose date
vacc_cis <- cis %>%
group_by(patient_id) %>%
mutate(vacc_date = min(covid_vaccine)) %>%
filter(vacc_date == covid_vaccine) %>%
ungroup() %>%
select(patient_id, vacc_date) %>%
distinct(.keep_all = TRUE)
# Earliest positive blood result from result_combined
earliest_pos_blood <- cis %>%
filter(result_combined == 1) %>%
group_by(patient_id) %>%
mutate(min_pos_result_comb = min(visit_date)) %>%
filter(min_pos_result_comb == visit_date) %>%
ungroup() %>%
select(patient_id, min_pos_result_comb) %>%
distinct(.keep_all = TRUE)
# Earliest +ve from self reported swab or blood test
min_pos_blood <- cis %>%
group_by(patient_id) %>%
mutate(min_self_blood = min(first_pos_blood)) %>%
filter(min_self_blood == first_pos_blood) %>%
ungroup() %>%
select(patient_id, min_self_blood) %>%
distinct(.keep_all = TRUE)
min_pos_swab <- cis %>%
group_by(patient_id) %>%
mutate(min_self_swab = min(first_pos_swab)) %>%
filter(min_self_swab == first_pos_swab) %>%
ungroup() %>%
select(patient_id, min_self_swab) %>%
distinct(.keep_all = TRUE)
# Join vaccine dates to earliest +ve blood (and self reported dates)
earliest_pos_blood <- earliest_pos_blood %>%
left_join(vacc_cis, by = 'patient_id') %>%
left_join(min_pos_blood, by = 'patient_id') %>%
left_join(min_pos_swab, by = 'patient_id')
View(earliest_pos_blood)
